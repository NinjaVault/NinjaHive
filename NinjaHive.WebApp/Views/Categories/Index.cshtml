@using NinjaHive.Contract.Models
@using NinjaHive.WebApp.Controllers
@using NinjaHive.WebApp.Extensions
@using NinjaHive.WebApp.Helpers
@model IReadOnlyCollection<MainCategoryModel>

<div class="row">
    <div class="page-header">
        <h2>Categories</h2>
    </div>

    <div id="ninjahive-content-container">
        <div id="ninjahive-content">

            <!--forms-->
            <div class="row">

                <!--main form-->
                <div class="col-md-6">
                    @Html.Partial(Partials.MainCategoryForm, new MainCategoryModel())
                </div>

                <!--sub form-->
                <div class="col-md-6">
                    @foreach (var category in Model)
                    {
                        <span class="subCategoryForm" data-parent-id="@category.Id">
                            @Html.Partial(Partials.SubCategoryForm, new SubCategoryModel
                            {
                                MainCategoryId = category.Id,
                            })
                        </span>
                    }
                </div>
            </div>

            <br />

            <!--content-->
            <div class="row">

                <!--main content-->
                <div class="col-md-6">
                    <div class="list-group" id="mainCategories">
                        @foreach (var category in Model)
                        {
                            <a href="#" class="list-group-item mainCategory" data-id="@category.Id">
                                @category.Name
                                <span data-id="@category.Id" class="glyphicon glyphicon-trash" style="float: right"></span>
                            </a>
                        }
                    </div>
                    @if (!Model.Any())
                    {
                        <div class="alert alert-danger" role="alert">
                            No Categories
                        </div>
                    }
                </div>

                <!--sub content-->
                <div class="col-md-6">
                    @foreach (var category in Model)
                    {
                        <div class="list-group subCategories" data-parent-id="@category.Id">
                            @foreach (var subCategory in category.SubCategories)
                            {
                                <a href="#" class="list-group-item" data-id="@subCategory.Id">
                                    <span class="name">@subCategory.Name</span>
                                    <span class="input">
                                        <input data-id="@subCategory.Id" data-parent-id="@subCategory.MainCategoryId" type="text" class="form-control" style="display: inline;">
                                        <span class="glyphicon glyphicon-ok save"></span>
                                    </span>
                                    <span data-id="@subCategory.Id" class="glyphicon glyphicon-trash" style="float: right"></span>
                                </a>
                            }
                        </div>
                    }
                </div>

            </div>
        </div>
    </div>
</div>

@Scripts.Render("~/bundles/extensions")
@Scripts.Render("~/bundles/ninjahive");

@section Scripts{
    <script>
        $(function () {
            $(".subCategoryForm, .subCategories").hide();
            $(".subCategoryForm:first-child, .subCategories:first-child").show();
            $("#mainCategories .mainCategory:first-child").addClass("active");

            $(".mainCategory").click(function (e) {
                var mainCategoryId = $(this).data("id");
                var attributeSelector = "[data-parent-id=\"" + mainCategoryId + "\"]";
                $(".subCategoryForm, .subCategories").hide();
                $(".subCategoryForm" + attributeSelector + ", .subCategories" + attributeSelector).show();
            });


            @{ var deleteUrl = UrlProvider<CategoriesController>.GetParameterlessUrl(c => c.Delete(Guid.Empty, false)); }

            $("#mainCategories .glyphicon-trash").on("click", function (e) {
                var id = $(this).data("id");

                var $subCategories = $(".subCategories[data-parent-id=\"" + id + "\"]:has(*)");

                if ($subCategories.length) {
                    
                    var alertDialog = ninjaHive.modal.alertDialog("Cannot Complete", "Cannot delete category because there are subcategories", true);
                    var content = "<ul>";
                    $subCategories.each(function (index, element) {
                            content += "<li>" + element.id + "</li>";
                        });
                    content += "</ul>";
                    alertDialog.setDynamicContent(content);

                } else {
                    $.post("@deleteUrl", { id: id, isMainCategory: true }, function () {
                        $(e.target).parent().remove();
                    });
                }
            });

            $(".subCategories .glyphicon-trash").on("click", function (e) {
                var id = $(this).data("id");

                @{ var getGameItems = UrlProvider<CategoriesController>.GetParameterlessUrl(c => c.GetLinkedGameItems(Guid.Empty)); }
                $.post("@getGameItems", { id: id }, function (data) {
                    if (data != null && !data.length) {

                        $.post("@deleteUrl", { id: id, isMainCategory: false }, function () {
                            $(e.target).parent().remove();
                        });

                    } else {
                        var alertDialog = ninjaHive.modal.alertDialog("Cannot Complete", "Cannot delete category because it is linked to game items", true);
                        alertDialog.setDynamicContent(data);
                    }
                });
            });

            var lastClick = null;
            $(".subCategories .input").hide();
            $(".subCategories .list-group-item").click(function (e) {
                var input = $(this).children(".input");
                if (lastClick === $(this).data("id")) {
                    input.children(":text").select();
                    return;
                }
                if (lastClick != null) {
                    var groupItem = ".list-group-item[data-id=\"" + lastClick + "\"]";
                    $(groupItem + " .name").show();
                    $(groupItem + " .input").hide();
                }
                lastClick = $(this).data("id");
                var name = $(this).children(".name");

                name.hide();
                input.show();
                input.children(":text").val(name.html());
                input.children(":text").select();
            });

            $(".save").click(function (e) {
                var id = $(this).prev().data("id");
                var mainId = $(this).prev().data("parent-id");
                var name = $(this).prev().val();
                var options = {
                    @{ var url = Url.Action<CategoriesController>(c => c.EditSubCategory(null)); }
                    url: "@url",
                    type: "POST",
                    cache: false,
                    data: {Id: id, Name: name, MainCategoryId: mainId},
                    success: function (responseData) {
                        $(this).parent().prev().val(name);
                        alert('saved');
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('error occurred. contact system admin');
                    },
                    complete: function () {
                    }
                };

                $.ajax(options);
            });
        });
    </script>
}